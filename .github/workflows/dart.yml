name: Build Flutter App (Android & iOS)
on:
  push: 
    branches:
      - main
permissions:
  contents: write
jobs:
  build-android:
    runs-on: ubuntu-latest
    name: Build Android APK
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      
      - name: Install dependencies
        run: flutter pub get
      
      # ğŸ¯ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ù‚Ø±Ø§Ø¡Ø© config.json ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
      - name: Read config.json and update app
        id: read_config
        run: |
          # Ù‚Ø±Ø§Ø¡Ø© Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† config.json
          APP_NAME=$(cat assets/config.json | jq -r '.app_name')
          USER_PHONE=$(cat assets/config.json | jq -r '.user_phone')
          RECIPIENT_NAME=$(cat assets/config.json | jq -r '.recipient_name')
          
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "user_phone=$USER_PHONE" >> $GITHUB_OUTPUT
          echo "recipient_name=$RECIPIENT_NAME" >> $GITHUB_OUTPUT
          
          echo "ğŸ“± App Name: $APP_NAME"
          echo "ğŸ“ Phone: $USER_PHONE"
          echo "ğŸ‘¤ Recipient: $RECIPIENT_NAME"
          
          # ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ Android
          sed -i "s/android:label=\"[^\"]*\"/android:label=\"$APP_NAME\"/g" android/app/src/main/AndroidManifest.xml
          
          # ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ iOS
          sed -i "s/<key>CFBundleDisplayName<\/key>[[:space:]]*<string>[^<]*<\/string>/<key>CFBundleDisplayName<\/key>\n\t<string>$APP_NAME<\/string>/g" ios/Runner/Info.plist
          
          echo "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­"
      
      # ğŸ¨ ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      - name: Update App Icon
        run: |
          # ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø®ØµØµØ©
          if [ -f "assets/icons/app_icon.png" ]; then
            echo "ğŸ¨ ÙˆØ¬Ø¯Øª Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø®ØµØµØ©ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«..."
            
            # Ø¥Ø¶Ø§ÙØ© flutter_launcher_icons Ù„Ù„Ù€ pubspec.yaml Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if ! grep -q "flutter_launcher_icons" pubspec.yaml; then
              cat >> pubspec.yaml << EOF
          
          flutter_launcher_icons:
            android: true
            ios: true
            image_path: "assets/icons/app_icon.png"
            adaptive_icon_background: "#FFFFFF"
            adaptive_icon_foreground: "assets/icons/app_icon.png"
          EOF
            fi
            
            # ØªÙ†ØµÙŠØ¨ ÙˆØªØ´ØºÙŠÙ„ flutter_launcher_icons
            flutter pub add dev:flutter_launcher_icons
            flutter pub get
            flutter pub run flutter_launcher_icons
            
            echo "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ù†Ø¬Ø§Ø­"
          else
            echo "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø®ØµØµØ© ÙÙŠ assets/icons/app_icon.png"
          fi
      
      - name: Build APK
        run: flutter build apk --release
      
      - name: Prepare APK with custom name
        id: prepare_apk
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø§Ù„Ù€ APK: app_name_user_phone
          APP_NAME="${{ steps.read_config.outputs.app_name }}"
          USER_PHONE="${{ steps.read_config.outputs.user_phone }}"
          
          # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù… (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙÙ‚Ø·ØŒ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù…)
          CLEAN_APP_NAME=$(echo "$APP_NAME" | sed 's/ /_/g')
          APK_NAME="${CLEAN_APP_NAME}_${USER_PHONE}.apk"
          
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ APK Name: $APK_NAME"
          
          # Ù†Ø³Ø® Ø§Ù„Ù€ APK
          mkdir -p apk_release
          cp build/app/outputs/flutter-apk/app-release.apk "apk_release/$APK_NAME"
      
      - name: Upload APK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: apk_release/${{ steps.prepare_apk.outputs.apk_name }}
  
  create-release:
    runs-on: ubuntu-latest
    needs: [build-android]
    name: Create GitHub Release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Read config for release info
        id: read_config
        run: |
          APP_NAME=$(cat assets/config.json | jq -r '.app_name')
          USER_PHONE=$(cat assets/config.json | jq -r '.user_phone')
          RECIPIENT_NAME=$(cat assets/config.json | jq -r '.recipient_name')
          OCCASION=$(cat assets/config.json | jq -r '.occasion')
          
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "user_phone=$USER_PHONE" >> $GITHUB_OUTPUT
          echo "recipient_name=$RECIPIENT_NAME" >> $GITHUB_OUTPUT
          echo "occasion=$OCCASION" >> $GITHUB_OUTPUT
      
      - name: Download Android APK
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: release/
      
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "${{ steps.read_config.outputs.app_name }}_${{ steps.read_config.outputs.user_phone }}"
          tag_name: "v1.0.${{ github.run_number }}"
          body: |
            ğŸ **${{ steps.read_config.outputs.app_name }}**
            
            ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${{ steps.read_config.outputs.user_phone }}
            ğŸ‘¤ Ø§Ù„Ù…Ø³ØªÙ„Ù…: ${{ steps.read_config.outputs.recipient_name }}
            ğŸ‰ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©: ${{ steps.read_config.outputs.occasion }}
            ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ù†Ø§Ø¡: ${{ github.event.head_commit.timestamp }}
            
            ---
            
            ### ğŸ“± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:
            Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù APK Ø£Ø¯Ù†Ø§Ù‡ ÙˆØªØ«Ø¨ÙŠØªÙ‡ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Android
            
            âœ¨ Made with Love
          files: |
            release/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
